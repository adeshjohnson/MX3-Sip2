function update_totals(){$("#free_booths_count").html($("tr.booth.free").size()),$("#active_calls_count").html($("tr.booth.occupied").size())}function httpGet(e){var t=null;return t=new XMLHttpRequest,t.open("GET",e,!1),t.send(null),t.responseText}function log(e){window.console?console.debug(e):alert(e)}function remove_slide_menus(e){$(e).next("tr.slide").remove()}!function(e){var t;e.fn.callshop=function(n,a){function s(e,t){null!=t.number?e.hide_form(t.element,"occupied"):e.hide_form(t.element,"reserved")}function i(t){t.find(".booth").each(function(t,a){e.map(n.booths,function(e){e.id==o(a)&&(e.element=a)})})}function r(t){return e.grep(n.booths,function(e){return e.id==o(t)?e:null})[0]}function o(t){return e(t).attr("id").match(/booth-(\d+)/)[1]}t=a,n=e.extend({id:null,free_booths:0,active_calls:0,refresh_interval:3e3,refresh:!0,cache:{booth_forms:{}},urls:{reservation:null,termination:null,termination_form:null,reservation_form:null,topup_form:null},updater:null,booths:null},n),e(this).each(function(){i(e(this)),e(this).find("a.start-session").live("click",function(t){t.preventDefault(),c.show_reservation_form(e(this).closest(".booth"))}),e(this).find("a.cancel").live("click",function(t){t.preventDefault();var n=r(e(this).closest(".booth"));switch(n.state){case"reservation_form":c.hide_form(n.element,"free");break;case"summary":null!=n.number?c.hide_form(n.element,"occupied"):c.hide_form(n.element,"reserved");break;case"topup":null!=n.number?c.hide_form(n.element,"occupied"):c.hide_form(n.element,"reserved");break;case"comment_update":null!=n.number?c.hide_form(n.element,"occupied"):c.hide_form(n.element,"reserved")}return!1}),e(this).find("input.cancel").live("click",function(){var n=e(this);e(this).jConfirmAction({question:t.confirm.question,yesAnswer:t.confirm.yes,cancelAnswer:t.confirm.cancel,callback:function(){c.hide_form(n.closest("tr.slide").prev(),"free")}})}),e("div.btn a.end-session").live("click",function(n){n.preventDefault();var a=r(e(this).closest(".booth"));"occupied"==a.state?e(this).jConfirmAction({question:t.confirm.question_terminated_calls,yesAnswer:t.confirm.yes,cancelAnswer:t.confirm.cancel,callback:function(){c.release_booth(a.element)}}):c.release_booth(a.element)}),e(this).find("input.release_booth").live("click",function(){var n=e(this);e(this).jConfirmAction({question:t.confirm.question,yesAnswer:t.confirm.yes,cancelAnswer:t.confirm.cancel,callback:function(){c.close_booth(n.closest("tr.slide").prev())}})}),e(this).find("input.reserve").live("click",function(t){t.preventDefault(),c.reserve_booth(e(this).closest("tr.slide").prev())}),e(this).find("a.topup-prepaid").live("click",function(t){t.preventDefault(),c.show_topup_form(e(this).closest(".booth"))}),e(this).find("a.comm-edit").live("click",function(t){t.preventDefault(),c.show_comment_update_form(e(this).closest(".booth"))}),e(this).find("input.comment-update").live("click",function(a){a.preventDefault(),e(this);var s=r(e(this).closest("tr.slide").prev()),i=e("#invoice_id").attr("value"),o=e("#invoice_comment").val();e.ajax({url:n.urls.update,postType:"json",cache:!1,data:{invoice_id:i,"invoice[comment]":o},beforeSend:function(){c.change_state(s,"loading",{})},success:function(){e(s.element).find(".comment").html(o+' <a href="" class="comm-edit" title="'+t.misc.update_comment+'" />'),null!=s.number?c.hide_form(s.element,"occupied"):c.hide_form(s.element,"reserved")}})}),e(this).find("input.increase").live("click",function(n){var a=e(n.currentTarget).parents(".slide"),s=Math.ceil(100*parseFloat(e(this).parents("table.invoice").find("input.balance").attr("value")))/100,i=parseFloat(r(e(this).parents("tr.slide").prev()).balance),o=1,c=parseFloat(e("#invoice_tax_1").attr("value")),l=parseFloat(e("#invoice_tax_2").attr("value")),d=parseFloat(e("#invoice_tax_3").attr("value")),u=parseFloat(e("#invoice_tax_4").attr("value")),p=e("#compound_tax").attr("value"),m=s;isNaN(s)||0>=s?(a.find(".decrease-balance").css("display","none"),a.find(".increase-balance").css("display","none"),alert(t.validations.numerical_and_non_zero)):(1==o&&(1==p?(u>0&&(m=100*(m/(u+100))),d>0&&(m=100*(m/(d+100))),l>0&&(m=100*(m/(l+100))),c>0&&(m=100*(m/(c+100)))):m/=(c+l+d+u)/100+1,s=Math.ceil(100*m)/100),a.find(".increase-balance").find(".addition").html(s),a.find(".increase-balance").find(".total").html(s+i),a.find(".increase-balance").css("display","inline"),a.find(".decrease-balance").css("display","none"))}),e(this).find("input.decrease").live("click",function(n){var a=e(n.currentTarget).parents(".slide"),s=Math.ceil(100*parseFloat(e(this).parents("table.invoice").find("input.balance").attr("value")))/100,i=parseFloat(r(e(this).parents("tr.slide").prev()).balance),o=1,c=parseFloat(e("#invoice_tax_1").attr("value")),l=parseFloat(e("#invoice_tax_2").attr("value")),d=parseFloat(e("#invoice_tax_3").attr("value")),u=parseFloat(e("#invoice_tax_4").attr("value")),p=e("#compound_tax").attr("value"),m=s;isNaN(s)||0>=s?(a.find(".decrease-balance").css("display","none"),a.find(".increase-balance").css("display","none"),alert(t.validations.numerical_and_non_zero)):(1==o&&(1==p?(u>0&&(m=100*(m/(u+100))),d>0&&(m=100*(m/(d+100))),l>0&&(m=100*(m/(l+100))),c>0&&(m=100*(m/(c+100)))):m/=(c+l+d+u)/100+1,s=Math.ceil(100*m)/100),a.find(".decrease-balance").find(".addition").html(s),a.find(".decrease-balance").find(".total").html(0>=i-s?0:i-s),a.find(".decrease-balance").css("display","inline"),a.find(".increase-balance").css("display","none"))}),e(this).find("input.adjust-balance").live("click",function(){e(this);var t=r(e(this).closest("tr.slide").prev()),a=e("#invoice_id").attr("value"),s=Math.ceil(100*parseFloat(e(this).parents("table.invoice").find("input.balance").attr("value")))/100,i=1;e.ajax({url:n.urls.top_up,postType:"json",cache:!1,data:{invoice_id:a,"invoice[balance]":parseFloat(s),add_with_tax:i,increase:"inline"==e(".increase-balance").css("display")},beforeSend:function(){c.change_state(t,"loading",{})},success:function(){null!=t.number?c.hide_form(t.element,"occupied"):c.hide_form(t.element,"reserved")}})}),e("#toggle-updating a").click(function(t){t.preventDefault(),e(this).hasClass("running")?(e(this).removeClass("running").addClass("not-running"),n.refresh=!1):(e(this).removeClass("not-running").addClass("running"),n.refresh=!0)}),e(this).find(".sort-col").live("click",function(t){t.preventDefault();var n=e(this),a={};n.parent().parent().children().each(function(t,a){e(a)[0]!=e(n.parent())[0]&&e(a).removeClass("sorted-on-asc sorted-on-desc")}),n.parent().hasClass("sorted-on-asc")?(n.parent().removeClass("sorted-on-asc").addClass("sorted-on-desc"),a=e.extend({reversed:!0},a)):n.parent().removeClass("sorted-on-desc").addClass("sorted-on-asc"),e("#callshop tbody").reorder("tr.booth",e.extend({by:function(e){return e.find("."+n.attr("data-sort-type")).text()}},a)),i(e("#callshop"))}),n.updater=e.periodic({period:n.refresh_interval,decay:1,max_period:1e4},function(){n.refresh&&e.ajax({url:n.urls.status_url_v2,dataType:"json",success:function(a){null!=a&&(e.each(a.booths,function(a,s){e.each(n.booths,function(n,a){if(s.id==a.id){if(s.timestamp!=a.timestamp||s.balance!=a.balance){var i=e("tr#booth-"+s.id);if(e.each(s,function(e){e.match(/element|local_state|state/)||(a[e]=s[e],i.find("."+e).html(null==a[e]?"-":a[e]))}),c.change_state(a,s.state,{remove:!1}),s.state.match(/occupied|reserved/)&&0==i.find(".comment").find("a").length&&i.find(".comment").append(' <a href="" class="comm-edit" title="'+t.misc.update_comment+'" />'),s.state.match(/occupied|reserved/)){var r=i.find(".balance"),o=httpGet("/billing/callshop/number_digits");r.html(sprintf("%."+o+"f",parseFloat(r.html()))),s.user_type.match(/postpaid/)?r.prepend(t.user_types.postpaid.toUpperCase()+" (").append(")").wrapInner(function(){var e=parseFloat(s.balance);return 0==e?"<span class='balance-value green' />":"<span class='balance-value red' />"}):r.prepend(t.user_types.prepaid.toUpperCase()+" (").append(")").append(e("<a href='' class='prepaid topup topup-prepaid' title='"+t.adjust_user_balance+"'>&nbsp;</a>")).wrapInner(function(){var e=parseFloat(s.balance);return 0>e?"<span class='balance-value red' />":"<span class='balance-value green' />"})}}if(s.timestamp!=a.timestamp||s.balance!=a.balance||s.duration!=a.duration){var l=e("tr#booth-"+s.id);a.duration=s.duration,l.find(".duration").html(null==a.duration?"-":a.duration)}}})}),update_totals())}})})});var c={show_reservation_form:function(t){var a=r(t);"reservation_form"!=a.state&&(a.element.id in n.cache.booth_forms?(e(n.cache.booth_forms[a.element.id]).insertAfter(e(a.element)).show(),c.change_state(a,"reservation_form",{})):e.ajax({url:n.urls.reservation_form,data:"user_id="+a.id,beforeSend:function(){c.change_state(a,"loading",{})},success:function(t){c.change_state(a,"reservation_form",{});var s=e(t).css("display","none"),i=new Array;i[a.element.id]=t,n.cache.booth_forms=e.extend(i,n.cache),s.insertAfter(e(a.element)).show()}}),e("#invoice_invoice_type_prepaid").live("click",function(){e(this).nextAll(".balance").css("display","inline")}),e("#invoice_invoice_type_postpaid").live("click",function(){e(this).nextAll(".balance").css("display","none")}))},hide_form:function(t,n){var a=r(t);e(a.element).nextUntil("tr.booth").each(function(t,n){e(n).remove()}),this.change_state(a,n,{})},reserve_booth:function(a){var s=r(a);""!=e("#invoice_balance").val()?e.ajax({url:n.urls.reservation,type:"post",postType:"json",cache:!1,data:e(s.element).next().find("form").serialize(),beforeSend:function(){c.change_state(s,"loading",{})},success:function(){c.hide_form(s.element,"reserved")}}):alert(t.validations.numerical_and_non_zero)},close_booth:function(t){var a,s,i=r(t),o=e("#invoice_comment")[0].value;e("#full_payment_received").length>0?(a=parseFloat(e("#pending_payment")[0].value),s=1==e("#full_payment_received")[0].checked):(a=e("#invoice_total").val(),s=!0),e.ajax({url:n.urls.termination,type:"post",data:"user_id="+i.id+"&comment="+o+"&balance="+a+"&full_payment="+s,beforeSend:function(){c.change_state(i,"loading",{})},success:function(){c.hide_form(i.element,"free")}})},release_booth:function(t){var a=r(t);"topup"!=a.state&&e.ajax({url:n.urls.termination_form,data:"user_id="+a.id+"&server="+a.server+"&channel="+a.channel,headers:{"X-CSRF-Token":"<%= form_authenticity_token.to_s %>"},beforeSend:function(){c.change_state(a,"loading",{})},success:function(t){c.change_state(a,"summary",{}),remove_slide_menus(e(a.element)),e(t).insertAfter(e(a.element))}})},show_comment_update_form:function(t){var a=r(t);"comment_update"!=a.state?e.ajax({url:n.urls.comment_update,data:"user_id="+a.id,beforeSend:function(){c.change_state(a,"loading",{})},success:function(t){s(c,a),c.change_state(a,"comment_update",{}),e(t).insertAfter(e(a.element))}}):s(c,a)},show_topup_form:function(t){var a=r(t);a.local_state||"summary"==a.state?s(c,a):e.ajax({url:n.urls.topup_form,data:"user_id="+a.id,beforeSend:function(){c.change_state(a,"loading",{})},success:function(t){s(c,a),c.change_state(a,"topup",{}),e(t).insertAfter(e(a.element))}})},change_state:function(n,a,s){var i={remove:!0};e.extend(i,s);var r=e(n.element).find("div.btn a"),o=e(n.element),c=r.hasClass("cancel");switch(r.removeClass("start-session preloader end-session cancel"),n.state=a,n.state){case"loading":r.html("&nbsp;").addClass("preloader");break;case"free":r.html("Start").addClass("start-session"),n.local_state=!1,o.find(".balance-value").removeClass("postpaid prepaid"),o.find(".balance").find("a").remove(),e(n.element).removeClass("reserved occupied").addClass("free");break;case"reservation_form":n.local_state=!0,r.html(t.states.cancel).addClass("cancel");break;case"reserved":r.html(t.states.end).addClass("end-session"),n.state="reserved",n.local_state=!1,e(n.element).removeClass("free occupied").addClass("reserved"),1==i.remove&&e(n.element).next("tr.slide").remove();break;case"summary":r.html(t.states.cancel).addClass("cancel"),e("#full_payment_received").live("click",function(){e("#pending_payment").val(sprintf("%.2f",parseFloat(e("#invoice_total").val()))),e("#pending_payment").trigger("change")}),e("#partial_payment_received").live("click",function(){e("#pending_payment").val(sprintf("%.2f",parseFloat(e("#invoice_current").val()))),e("#pending_payment").trigger("change")}),e("#pending_payment").live("change",function(){e("#money_return").html(sprintf("%.2f",parseFloat(e("#pending_payment").val())-parseFloat(e("#invoice_total").val()))+" "+s.currency)});break;case"topup":n.local_state=!0,r.html(t.states.cancel).addClass("cancel");break;case"occupied":e(n.element).removeClass("reserved free").addClass("occupied"),1==c?r.html(t.states.cancel).addClass("cancel"):r.html(t.states.end).addClass("end-session"),1==i.remove&&e(n.element).next("tr.slide").remove(),n.state="occupied",n.local_state=!1;break;case"comment_update":n.local_state=!0,r.html(t.states.cancel).addClass("cancel")}}}}}(jQuery);