// Copyright 2006 Mikel Maron (email: mikel_maron yahoo com)
function GeoRssOverlay(e,t,s,i){this.rssurl=e,this.icon=t,this.proxyurl=s,this.visible=void 0==i.visible?!0:i.visible,this.listDiv=i.listDiv,this.contentDiv=i.contentDiv,this.listItemClass=i.listItemClass,this.limitItems=i.limit,this.request=!1,this.markers=[]}GeoRssOverlay.prototype=new GOverlay,GeoRssOverlay.prototype.initialize=function(e){this.map=e,this.load()},GeoRssOverlay.prototype.redraw=function(){},GeoRssOverlay.prototype.remove=function(){for(var e=0,t=this.markers.length;t>e;e++)this.map.removeOverlay(this.markers[e])},GeoRssOverlay.prototype.showHide=function(){if(this.visible){for(var e=0;e<this.markers.length;e++)this.map.removeOverlay(this.markers[e]);this.visible=!1}else{for(var e=0;e<this.markers.length;e++)this.map.addOverlay(this.markers[e]);this.visible=!0}},GeoRssOverlay.prototype.showMarker=function(e){var t=this.markers[e];void 0!=t&&GEvent.trigger(t,"click")},GeoRssOverlay.prototype.copy=function(){var e=new GeoRssOVerlay(this.rssurl,this.icon,this.proxyurl);e.markers=[];for(var t=0,s=this.markers.length;s>t;t++)e.markers.push(this.markers[t].copy());return e},GeoRssOverlay.prototype.load=function(){if(0==this.request){this.request=GXmlHttp.create(),void 0!=this.proxyurl?this.request.open("GET",this.proxyurl+"?q="+encodeURIComponent(this.rssurl),!0):this.request.open("GET",this.rssurl,!0);var e=this;this.request.onreadystatechange=function(){e.callback()},this.request.send(null)}},GeoRssOverlay.prototype.callback=function(){if(4==this.request.readyState){if("200"==this.request.status){var e=this.request.responseXML;if(0!=e.documentElement.getElementsByTagName("item").length)var t=e.documentElement.getElementsByTagName("item");else if(0!=e.documentElement.getElementsByTagName("entry").length)var t=e.documentElement.getElementsByTagName("entry");for(var s=0,i=this.limitItems?Math.min(this.limitItems,t.length):t.length;i>s;s++)try{var r=this.createMarker(t[s],s);this.markers.push(r),this.visible&&this.map.addOverlay(r)}catch(a){}}this.request=!1}},GeoRssOverlay.prototype.createMarker=function(e,t){var s=e.getElementsByTagName("title")[0].childNodes[0].nodeValue;if(0!=e.getElementsByTagName("description").length)var i=e.getElementsByTagName("description")[0].childNodes[0].nodeValue,r=e.getElementsByTagName("link")[0].childNodes[0].nodeValue;else if(0!=e.getElementsByTagName("summary").length)var i=e.getElementsByTagName("summary")[0].childNodes[0].nodeValue,r=e.getElementsByTagName("link")[0].attributes[0].nodeValue;if(navigator.userAgent.toLowerCase().indexOf("msie")<0){if(0!=e.getElementsByTagNameNS("http://www.w3.org/2003/01/geo/wgs84_pos#","lat").length)var a=e.getElementsByTagNameNS("http://www.w3.org/2003/01/geo/wgs84_pos#","lat")[0].childNodes[0].nodeValue,l=e.getElementsByTagNameNS("http://www.w3.org/2003/01/geo/wgs84_pos#","long")[0].childNodes[0].nodeValue;else if(0!=e.getElementsByTagNameNS("http://www.georss.org/georss","point").length)var n=e.getElementsByTagNameNS("http://www.georss.org/georss","point")[0].childNodes[0].nodeValue.split(" "),a=n[0],l=n[1]}else if(0!=e.getElementsByTagName("geo:lat").length)var a=e.getElementsByTagName("geo:lat")[0].childNodes[0].nodeValue,l=e.getElementsByTagName("geo:long")[0].childNodes[0].nodeValue;else if(0!=e.getElementsByTagName("georss:point").length)var n=e.getElementsByTagName("georss:point")[0].childNodes[0].nodeValue.split(" "),a=n[0],l=n[1];var o=new GLatLng(parseFloat(a),parseFloat(l)),m=new GMarker(o,{title:s}),h='<a href="'+r+'">'+s+"</a><p/>"+i;if(void 0==this.contentDiv)GEvent.addListener(m,"click",function(){m.openInfoWindowHtml(h)});else{var g=this.contentDiv;GEvent.addListener(m,"click",function(){document.getElementById(g).innerHTML=h})}if(void 0!=this.listDiv){var d=document.createElement("a");d.innerHTML=s,d.setAttribute("href","#");var v=this;d.onclick=function(){return v.showMarker(t),!1};var u=document.createElement("div");void 0!=this.listItemClass&&u.setAttribute("class",this.listItemClass),u.appendChild(d),document.getElementById(this.listDiv).appendChild(u)}return m};