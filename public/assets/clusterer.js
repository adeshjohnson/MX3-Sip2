// Copyright  2005,2006 by Jef Poskanzer <jef@mail.acme.com>.
// 1. Redistributions of source code must retain the above copyright
// 2. Redistributions in binary form must reproduce the above copyright
function addDescriptionToMarker(e,r){return e.description=r,e}Clusterer=function(e,r,t,o,n,s){if(this.markers=[],e)for(var l=0;l<e.length;l++)this.addMarker(e[l]);this.clusters=[],this.timeout=null,this.maxVisibleMarkers=t||150,this.gridSize=o||5,this.minMarkersPerCluster=n||5,this.maxLinesPerInfoBox=s||10,this.icon=r||G_DEFAULT_ICON},Clusterer.prototype=new GOverlay,Clusterer.prototype.initialize=function(e){this.map=e,this.currentZoomLevel=e.getZoom(),GEvent.addListener(e,"zoomend",Clusterer.makeCaller(Clusterer.display,this)),GEvent.addListener(e,"moveend",Clusterer.makeCaller(Clusterer.display,this)),GEvent.addListener(e,"infowindowclose",Clusterer.makeCaller(Clusterer.popDown,this));for(var r=0,t=this.markers.length;t>r;r++)this.markers[r].setMap(e);this.displayLater()},Clusterer.prototype.remove=function(){for(var e=0;e<this.markers.length;++e)this.removeMarker(this.markers[e])},Clusterer.prototype.copy=function(){return new Clusterer(this.markers,this.icon,this.maxVisibleMarkers,this.gridSize,this.minMarkersPerCluster,this.maxLinesPerInfoBox)},Clusterer.prototype.redraw=function(){this.displayLater()},Clusterer.prototype.setIcon=function(e){this.icon=e},Clusterer.prototype.addMarker=function(e,r){e.onMap=!1,this.markers.push(e),e.description=e.description||r,null!=this.map&&(e.setMap(this.map),this.displayLater())},Clusterer.prototype.removeMarker=function(e){for(var r=0;r<this.markers.length;++r)if(this.markers[r]==e){e.onMap&&this.map.removeOverlay(e);for(var t=0;t<this.clusters.length;++t){var o=this.clusters[t];if(null!=o){for(var n=0;n<o.markers.length;++n)if(o.markers[n]==e){o.markers[n]=null,--o.markerCount;break}0==o.markerCount?(this.clearCluster(o),this.clusters[t]=null):o==this.poppedUpCluster&&Clusterer.rePop(this)}}this.markers[r]=null;break}this.displayLater()},Clusterer.prototype.displayLater=function(){null!=this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(Clusterer.makeCaller(Clusterer.display,this),50)},Clusterer.display=function(e){var r,t,o,n,s,l;clearTimeout(e.timeout);var a=e.map.getZoom();if(a!=e.currentZoomLevel){for(r=0,s=e.clusters.length;s>r;++r)null!=e.clusters[r]&&(e.clearCluster(e.clusters[r]),e.clusters[r]=null);e.clusters.length=0,e.currentZoomLevel=a}var i=e.map.getBounds(),p=i.getSouthWest(),u=i.getNorthEast(),m=u.lng()-p.lng(),h=u.lat()-p.lat();m*=.1,h*=.1,i=new GLatLngBounds(new GLatLng(p.lat()-h,p.lng()-m),new GLatLng(u.lat()+h,u.lng()+m));var c=[],g=[];for(r=0,s=e.markers.length;s>r;++r)o=e.markers[r],null!=o&&(i.contains(o.getPoint())?c.push(o):g.push(o));for(r=0,s=g.length;s>r;++r)o=g[r],o.onMap&&(e.map.removeOverlay(o),o.onMap=!1);for(r=0,s=e.clusters.length;s>r;++r)n=e.clusters[r],null!=n&&!i.contains(n.marker.getPoint())&&n.onMap&&(e.map.removeOverlay(n.marker),n.onMap=!1);if(c.length>e.maxVisibleMarkers){for(var d=i.getNorthEast().lat()-i.getSouthWest().lat(),f=d/e.gridSize,k=f/Math.cos((i.getNorthEast().lat()+i.getSouthWest().lat())/2*Math.PI/180),C=i.getSouthWest().lat();C<=i.getNorthEast().lat();C+=f)for(var M=i.getSouthWest().lng();M<=i.getNorthEast().lng();M+=k)n=new Object,n.clusterer=e,n.bounds=new GLatLngBounds(new GLatLng(C,M),new GLatLng(C+f,M+k)),n.markers=[],n.markerCount=0,n.onMap=!1,n.marker=null,e.clusters.push(n);for(r=0,s=c.length;s>r;++r)if(o=c[r],null!=o&&!o.inCluster)for(t=0,l=e.clusters.length;l>t;++t)n=e.clusters[t],null!=n&&n.bounds.contains(o.getPoint())&&(n.markers.push(o),++n.markerCount,o.inCluster=!0);for(r=0,s=e.clusters.length;s>r;++r)null!=e.clusters[r]&&e.clusters[r].markerCount<e.minMarkersPerCluster&&(e.clearCluster(e.clusters[r]),e.clusters[r]=null);for(r=e.clusters.length-1;r>=0&&null==e.clusters[r];--r)--e.clusters.length;for(r=0,s=e.clusters.length;s>r;++r)if(n=e.clusters[r],null!=n)for(t=0,l=n.markers.length;l>t;++t)o=n.markers[t],null!=o&&o.onMap&&(e.map.removeOverlay(o),o.onMap=!1);for(r=0,s=e.clusters.length;s>r;++r)if(n=e.clusters[r],null!=n&&null==n.marker){var w=0,y=0;for(t=0,l=n.markers.length;l>t;++t)o=n.markers[t],null!=o&&(w+=+o.getPoint().lng(),y+=+o.getPoint().lat());var v=new GLatLng(y/n.markerCount,w/n.markerCount);o=new GMarker(v,{icon:e.icon}),n.marker=o,GEvent.addListener(o,"click",Clusterer.makeCaller(Clusterer.popUp,n))}}for(r=0,s=c.length;s>r;++r)o=c[r],null==o||o.onMap||o.inCluster||(e.map.addOverlay(o),o.addedToMap(),o.onMap=!0);for(r=0,s=e.clusters.length;s>r;++r)n=e.clusters[r],null!=n&&!n.onMap&&i.contains(n.marker.getPoint())&&(e.map.addOverlay(n.marker),n.onMap=!0);Clusterer.rePop(e)},Clusterer.popUp=function(e){for(var r=e.clusterer,t='<table width="300">',o=0,n=0,s=e.markers.length;s>n;++n){var l=e.markers[n];if(null!=l&&(++o,t+="<tr><td>",t+=null!=l.getIcon().smallImage?'<img src="'+l.getIcon().smallImage+'">':'<img src="'+l.getIcon().image+'" width="'+l.getIcon().iconSize.width/2+'" height="'+l.getIcon().iconSize.height/2+'">',t+="</td><td>"+l.description+"</td></tr>",o==r.maxLinesPerInfoBox-1&&e.markerCount>r.maxLinesPerInfoBox)){t+='<tr><td colspan="2">...and '+(e.markerCount-o)+" more</td></tr>";break}}t+="</table>",r.map.closeInfoWindow(),e.marker.openInfoWindowHtml(t),r.poppedUpCluster=e},Clusterer.rePop=function(e){null!=e.poppedUpCluster&&Clusterer.popUp(e.poppedUpCluster)},Clusterer.popDown=function(e){e.poppedUpCluster=null},Clusterer.prototype.clearCluster=function(e){var r;for(r=0;r<e.markers.length;++r)null!=e.markers[r]&&(e.markers[r].inCluster=!1,e.markers[r]=null);e.markers.length=0,e.markerCount=0,e==this.poppedUpCluster&&this.map.closeInfoWindow(),e.onMap&&(this.map.removeOverlay(e.marker),e.onMap=!1)},Clusterer.makeCaller=function(e,r){return function(){e(r)}},GMarker.prototype.setMap=function(e){this.map=e},GMarker.prototype.getMap=function(){return this.map},GMarker.prototype.addedToMap=function(){this.map=null},GMarker.prototype.origOpenInfoWindow=GMarker.prototype.openInfoWindow,GMarker.prototype.openInfoWindow=function(e,r){return null!=this.map?this.map.openInfoWindow(this.getPoint(),e,r):this.origOpenInfoWindow(e,r)},GMarker.prototype.origOpenInfoWindowHtml=GMarker.prototype.openInfoWindowHtml,GMarker.prototype.openInfoWindowHtml=function(e,r){return null!=this.map?this.map.openInfoWindowHtml(this.getPoint(),e,r):this.origOpenInfoWindowHtml(e,r)},GMarker.prototype.origOpenInfoWindowTabs=GMarker.prototype.openInfoWindowTabs,GMarker.prototype.openInfoWindowTabs=function(e,r){return null!=this.map?this.map.openInfoWindowTabs(this.getPoint(),e,r):this.origOpenInfoWindowTabs(e,r)},GMarker.prototype.origOpenInfoWindowTabsHtml=GMarker.prototype.openInfoWindowTabsHtml,GMarker.prototype.openInfoWindowTabsHtml=function(e,r){return null!=this.map?this.map.openInfoWindowTabsHtml(this.getPoint(),e,r):this.origOpenInfoWindowTabsHtml(e,r)},GMarker.prototype.origShowMapBlowup=GMarker.prototype.showMapBlowup,GMarker.prototype.showMapBlowup=function(e){return null!=this.map?this.map.showMapBlowup(this.getPoint(),e):this.origShowMapBlowup(e)};