if(!Control)var Control={};Control.colorPickers=[],Control.ColorPicker=Class.create(),Control.ColorPicker.activeColorPicker,Control.ColorPicker.CONTROL,Control.ColorPicker.prototype={initialize:function(t,i){var e=this;if(Control.colorPickers.push(e),this.field=$(t),this.fieldName=this.field.name||this.field.id,this.options=Object.extend({IMAGE_BASE:"colorpicker/img/"},i||{}),this.swatch=$(this.options.swatch)||this.field,this.rgb={},this.hsv={},this.isOpen=!1,!Control.ColorPicker.CONTROL){if(Control.ColorPicker.CONTROL={},!$("colorpicker")){var o=Builder.node("div",{id:"colorpicker"});o.innerHTML='<div id="colorpicker-div">'+(/MSIE ((6)|(5\.5))/gi.test(navigator.userAgent)&&/windows/i.test(navigator.userAgent)&&!/opera/i.test(navigator.userAgent)?'<img id="colorpicker-bg" src="'+this.options.IMAGE_BASE+'blank.gif" style="filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=\''+this.options.IMAGE_BASE+"pickerbg.png', sizingMethod='scale')\" alt=\"\">":'<img id="colorpicker-bg" src="'+this.options.IMAGE_BASE+'pickerbg.png" alt="">')+'<div id="colorpicker-bg-overlay" style="z-index: 1002;"></div>'+'<div id="colorpicker-selector"><img src="'+this.options.IMAGE_BASE+'select.gif" width="11" height="11" alt="" /></div></div>'+'<div id="colorpicker-hue-container"><img src="'+this.options.IMAGE_BASE+'hue.png" id="colorpicker-hue-bg-img"><div id="colorpicker-hue-slider"><div id="colorpicker-hue-thumb"><img src="'+this.options.IMAGE_BASE+'hline.png"></div></div></div>'+'<div id="colorpicker-footer"><span id="colorpicker-value">#<input type="text" onclick="this.select()" id="colorpicker-value-input" name="colorpicker-value" value=""></input></span><button id="colorpicker-okbutton">OK</button></div>',document.body.appendChild(o)}Control.ColorPicker.CONTROL={popUp:$("colorpicker"),pickerArea:$("colorpicker-div"),selector:$("colorpicker-selector"),okButton:$("colorpicker-okbutton"),value:$("colorpicker-value"),input:$("colorpicker-value-input"),picker:new Draggable($("colorpicker-selector"),{snap:function(t,i){return[Math.min(Math.max(t,0),Control.ColorPicker.activeColorPicker.control.pickerArea.offsetWidth),Math.min(Math.max(i,0),Control.ColorPicker.activeColorPicker.control.pickerArea.offsetHeight)]},zindex:1009,change:function(t){var i=t.currentDelta();Control.ColorPicker.activeColorPicker.update(i[0],i[1])}}),hueSlider:new Control.Slider("colorpicker-hue-thumb","colorpicker-hue-slider",{axis:"vertical",onChange:function(t){Control.ColorPicker.activeColorPicker.updateHue(t)}})},Element.hide($("colorpicker"))}this.control=Control.ColorPicker.CONTROL,this.toggleOnClickListener=this.toggle.bindAsEventListener(this),this.updateOnChangeListener=this.updateFromFieldValue.bindAsEventListener(this),this.closeOnClickOkListener=this.close.bindAsEventListener(this),this.updateOnClickPickerListener=this.updateSelector.bindAsEventListener(this),Event.observe(this.swatch,"click",this.toggleOnClickListener),Event.observe(this.field,"change",this.updateOnChangeListener),Event.observe(this.control.input,"change",this.updateOnChangeListener),this.updateSwatch()},toggle:function(t){this[this.isOpen?"close":"open"](t),Event.stop(t)},open:function(t){if(Control.colorPickers.each(function(t){t.close()}),Control.ColorPicker.activeColorPicker=this,this.isOpen=!0,Element.show(this.control.popUp),this.options.getPopUpPosition)var i=this.options.getPopUpPosition.bind(this)(t);else{var i=Position.cumulativeOffset(this.swatch||this.field);i[0]=i[0]+(this.swatch||this.field).offsetWidth+10}this.control.popUp.style.left=i[0]+"px",this.control.popUp.style.top=i[1]+"px",this.updateFromFieldValue(),Event.observe(this.control.okButton,"click",this.closeOnClickOkListener),Event.observe(this.control.pickerArea,"mousedown",this.updateOnClickPickerListener),this.options.onOpen&&this.options.onOpen.bind(this)(t)},close:function(){Control.ColorPicker.activeColorPicker==this&&(Control.ColorPicker.activeColorPicker=null),this.isOpen=!1,Element.hide(this.control.popUp),Event.stopObserving(this.control.okButton,"click",this.closeOnClickOkListener),Event.stopObserving(this.control.pickerArea,"mousedown",this.updateOnClickPickerListener),this.options.onClose&&this.options.onClose.bind(this)()},updateHue:function(t){var i=(this.control.pickerArea.offsetHeight-100*t)/this.control.pickerArea.offsetHeight;1==i&&(i=0);var e=YAHOO.util.Color.hsv2rgb(i,1,1);YAHOO.util.Color.isValidRGB(e)&&(this.control.pickerArea.style.backgroundColor="rgb("+e[0]+", "+e[1]+", "+e[2]+")",this.update())},updateFromFieldValue:function(t){if(this.isOpen){var i=t&&Event.findElement(t,"input")||this.field,e=YAHOO.util.Color.hex2rgb(i.value);if(YAHOO.util.Color.isValidRGB(e)){var o=YAHOO.util.Color.rgb2hsv(e[0],e[1],e[2]);this.control.selector.style.left=Math.round(o[1]*this.control.pickerArea.offsetWidth)+"px",this.control.selector.style.top=Math.round((1-o[2])*this.control.pickerArea.offsetWidth)+"px",this.control.hueSlider.setValue(1-o[0])}}},updateSelector:function(t){var i=Event.pointerX(t),e=Event.pointerY(t),o=Position.cumulativeOffset($("colorpicker-bg"));this.control.selector.style.left=i-o[0]-6+"px",this.control.selector.style.top=e-o[1]-6+"px",this.update(i-o[0],e-o[1]),this.control.picker.initDrag(t)},updateSwatch:function(){var t=YAHOO.util.Color.hex2rgb(this.field.value);if(YAHOO.util.Color.isValidRGB(t)){this.swatch.style.backgroundColor="rgb("+t[0]+", "+t[1]+", "+t[2]+")";var i=YAHOO.util.Color.rgb2hsv(t[0],t[1],t[2]);this.swatch.style.color=i[2]>.65?"#000000":"#FFFFFF"}},update:function(t,i){t||(t=this.control.picker.currentDelta()[0]),i||(i=this.control.picker.currentDelta()[1]);var e=(this.control.pickerArea.offsetHeight-100*this.control.hueSlider.value)/this.control.pickerArea.offsetHeight;1==e&&(e=0),this.hsv={hue:1-this.control.hueSlider.value,saturation:t/this.control.pickerArea.offsetWidth,brightness:(this.control.pickerArea.offsetHeight-i)/this.control.pickerArea.offsetHeight};var o=YAHOO.util.Color.hsv2rgb(this.hsv.hue,this.hsv.saturation,this.hsv.brightness);this.rgb={red:o[0],green:o[1],blue:o[2]},this.field.value=YAHOO.util.Color.rgb2hex(o[0],o[1],o[2]),this.control.input.value=this.field.value,this.updateSwatch(),this.options.onUpdate&&this.options.onUpdate.bind(this)(this.field.value)}};